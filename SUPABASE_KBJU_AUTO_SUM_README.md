# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ö–ë–ñ–£ üìä

## –ß—Ç–æ —ç—Ç–æ?

–¢–µ–ø–µ—Ä—å –≤–∞—à–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ö–ë–ñ–£ (–ö–∞–ª–æ—Ä–∏–∏, –ë–µ–ª–∫–∏, –ñ–∏—Ä—ã, –£–≥–ª–µ–≤–æ–¥—ã) –≤ —Ç–∞–±–ª–∏—Ü–µ [`daily_stats`](SUPABASE_SETUP_COMPLETE.sql:75) –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ [`food_entries`](SUPABASE_SETUP_COMPLETE.sql:37).

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¢—Ä–∏–≥–≥–µ—Ä—ã

–°–æ–∑–¥–∞–Ω—ã —Ç—Ä–∏ —Ç–∏–ø–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤:

1. **–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ (INSERT)**
   - –ö–æ–≥–¥–∞ –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –æ –µ–¥–µ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ö–ë–ñ–£ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
   
2. **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ (UPDATE)**
   - –ï—Å–ª–∏ –≤—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å –æ –µ–¥–µ, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
   - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –¥–∞—Ç–∞ –∑–∞–ø–∏—Å–∏, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –æ–±–µ–∏—Ö –¥–∞—Ç (—Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π)
   
3. **–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ (DELETE)**
   - –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –æ –µ–¥–µ, –¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è

### –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞

–§—É–Ω–∫—Ü–∏—è [`recalculate_daily_stats()`](SUPABASE_SETUP_COMPLETE.sql:155) –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

- –°—É–º–º–∏—Ä—É–µ—Ç –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è `calories`, `protein`, `fat`, `carbs` –∏–∑ `food_entries` –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–µ–Ω—å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ `daily_stats` –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `UPSERT` (INSERT ... ON CONFLICT) –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ù–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

–ï—Å–ª–∏ –≤—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª:

```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å—å —Ñ–∞–π–ª SUPABASE_SETUP_COMPLETE.sql –≤ SQL Editor
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î

–ï—Å–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –º–∏–≥—Ä–∞—Ü–∏—é:

```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–π–ª supabase/migrations/002_food_entries_daily_stats_triggers.sql
```

–ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é —Ç–æ–ª—å–∫–æ —Å–µ–∫—Ü–∏—é 5 –∏–∑ [`SUPABASE_SETUP_COMPLETE.sql`](SUPABASE_SETUP_COMPLETE.sql:151) (—Å—Ç—Ä–æ–∫–∏ 151-257).

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –µ–¥–µ

```javascript
// –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ API
const { data, error } = await supabase
  .from('food_entries')
  .insert({
    user_telegram_id: '123456789',
    description: '–û–≤—Å—è–Ω–∫–∞ —Å –±–∞–Ω–∞–Ω–æ–º',
    meal_type: 'breakfast',
    calories: 350,
    protein: 12,
    fat: 8,
    carbs: 55
  });

// daily_stats –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è! ‚úÖ
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ daily_stats

–ü–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏, –≤ [`daily_stats`](SUPABASE_SETUP_COMPLETE.sql:75) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∑–∞–ø–∏—Å—å:

```sql
SELECT * FROM daily_stats 
WHERE user_telegram_id = '123456789' 
  AND date = CURRENT_DATE;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- total_calories: 350
-- total_protein: 12.00
-- total_fat: 8.00
-- total_carbs: 55.00
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ—â–µ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏

```javascript
// –î–æ–±–∞–≤–ª—è–µ–º –æ–±–µ–¥
const { data, error } = await supabase
  .from('food_entries')
  .insert({
    user_telegram_id: '123456789',
    description: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ —Å —Ä–∏—Å–æ–º',
    meal_type: 'lunch',
    calories: 450,
    protein: 45,
    fat: 10,
    carbs: 50
  });
```

–¢–µ–ø–µ—Ä—å –≤ [`daily_stats`](SUPABASE_SETUP_COMPLETE.sql:75) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç:
- `total_calories`: 800 (350 + 450)
- `total_protein`: 57.00 (12 + 45)
- `total_fat`: 18.00 (8 + 10)
- `total_carbs`: 105.00 (55 + 50)

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–ª—è—Ç—å `daily_stats`  
‚úÖ **–í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ** - –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** - —Ç—Ä–∏–≥–≥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö  
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ** - –ø–µ—Ä–µ—Å—á–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω—É–∂–Ω–æ–≥–æ –¥–Ω—è  
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–ª—É—á–∞–∏: INSERT, UPDATE, DELETE  

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

‚ö†Ô∏è **–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏**: –§—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `DATE(created_date)` –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–ø–∏—Å–µ–π –ø–æ –¥–Ω—è–º  
‚ö†Ô∏è **Timezone**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Ä–µ–º—è —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω–æ–π  
‚ö†Ô∏è **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ**: –î–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤—Ä—É—á–Ω—É—é:

```sql
-- –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞—Ç—ã
SELECT recalculate_daily_stats('123456789', '2025-12-27');
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –¢–µ—Å—Ç —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

```sql
-- 1. –î–æ–±–∞–≤–∏–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
INSERT INTO food_entries (
  user_telegram_id,
  description,
  meal_type,
  calories,
  protein,
  fat,
  carbs
) VALUES (
  'test_user',
  '–¢–µ—Å—Ç–æ–≤–∞—è –µ–¥–∞',
  'breakfast',
  100,
  10,
  5,
  15
);

-- 2. –ü—Ä–æ–≤–µ—Ä–∏–º daily_stats
SELECT * FROM daily_stats 
WHERE user_telegram_id = 'test_user' 
  AND date = CURRENT_DATE;

-- –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å —Å total_calories=100, total_protein=10, –∏ —Ç.–¥.

-- 3. –î–æ–±–∞–≤–∏–º –µ—â–µ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å
INSERT INTO food_entries (
  user_telegram_id,
  description,
  meal_type,
  calories,
  protein,
  fat,
  carbs
) VALUES (
  'test_user',
  '–ï—â–µ –µ–¥–∞',
  'lunch',
  200,
  20,
  10,
  30
);

-- 4. –°–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä–∏–º daily_stats
SELECT * FROM daily_stats 
WHERE user_telegram_id = 'test_user' 
  AND date = CURRENT_DATE;

-- –¢–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: total_calories=300, total_protein=30, –∏ —Ç.–¥.

-- 5. –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
DELETE FROM food_entries WHERE user_telegram_id = 'test_user';
```

## –§–∞–π–ª—ã

- [`SUPABASE_SETUP_COMPLETE.sql`](SUPABASE_SETUP_COMPLETE.sql) - –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ë–î —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
- [`supabase/migrations/002_food_entries_daily_stats_triggers.sql`](supabase/migrations/002_food_entries_daily_stats_triggers.sql) - –¢–æ–ª—å–∫–æ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä—ã —Å–æ–∑–¥–∞–Ω—ã:
   ```sql
   SELECT trigger_name, event_manipulation, event_object_table 
   FROM information_schema.triggers 
   WHERE event_object_table = 'food_entries';
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç:
   ```sql
   SELECT proname FROM pg_proc 
   WHERE proname LIKE '%daily_stats%';
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Supabase –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

---

**–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –≤–∞—à–∞ –ë–î –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—É–º–º–∏—Ä—É–µ—Ç –ö–ë–ñ–£! üéâ**
