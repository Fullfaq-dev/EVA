# Миграция: Добавление BMI и Weight Status

## Описание изменений

Обновлена система расчета БЖУ с учётом индекса массы тела (BMI) и весовой категории пользователя.

## Что изменилось

### 1. База данных (Supabase)

Добавлены новые поля в таблицу `user_profiles`:
- `bmi` (DECIMAL(4,1)) - индекс массы тела
- `weight_status` (TEXT) - весовая категория: `underweight`, `normal`, `overweight`, `obese`

### 2. Логика расчета БЖУ

**До:**
- БЖУ рассчитывались как процент от калорий
- Не учитывался BMI и весовая категория
- Формулы были упрощенными

**После:**
- Белок рассчитывается на основе веса тела (г/кг) с коррекцией по весовой категории
- Жиры рассчитываются на основе веса тела (г/кг) с защитой гормональной системы
- Углеводы рассчитываются остатком калорий после белков и жиров
- Калории корректируются в зависимости от BMI:
  - Недобор веса (BMI < 18.5): +10%
  - Избыточный вес (BMI 25-30): -5%
  - Ожирение (BMI ≥ 30): -10%
  - Норма (BMI 18.5-25): без изменений

### 3. Измененные файлы

1. **`src/utils/nutritionCalculator.js`**
   - Полностью переработана формула расчета БЖУ
   - Добавлен расчет BMI и определение весовой категории
   - Функция теперь возвращает `bmi` и `weightStatus`

2. **`src/pages/Onboarding.jsx`**
   - Обновлено сохранение профиля для включения BMI и weight_status

3. **`src/pages/Profile.jsx`**
   - Обновлено обновление профиля для пересчета BMI и weight_status

4. **`supabase/migrations/003_add_bmi_weight_status.sql`** (новый файл)
   - Миграция для добавления полей в базу данных

## Как применить изменения

### Шаг 1: Применить миграцию в Supabase

Выполните SQL-скрипт в Supabase SQL Editor:

```sql
-- Добавление полей BMI и weight_status в таблицу user_profiles
ALTER TABLE user_profiles 
ADD COLUMN bmi DECIMAL(4,1),
ADD COLUMN weight_status TEXT CHECK (weight_status IN ('underweight', 'normal', 'overweight', 'obese'));

-- Комментарии для документации
COMMENT ON COLUMN user_profiles.bmi IS 'Body Mass Index, рассчитывается автоматически при обновлении профиля';
COMMENT ON COLUMN user_profiles.weight_status IS 'Весовая категория: underweight (BMI < 18.5), normal (18.5-25), overweight (25-30), obese (>= 30)';
```

### Шаг 2: Обновить существующих пользователей (опционально)

Если у вас уже есть пользователи, можно пересчитать их BMI и weight_status:

```sql
-- Обновление BMI и weight_status для существующих пользователей
UPDATE user_profiles
SET 
  bmi = ROUND((weight / ((height / 100.0) * (height / 100.0)))::numeric, 1),
  weight_status = CASE
    WHEN (weight / ((height / 100.0) * (height / 100.0))) < 18.5 THEN 'underweight'
    WHEN (weight / ((height / 100.0) * (height / 100.0))) < 25 THEN 'normal'
    WHEN (weight / ((height / 100.0) * (height / 100.0))) < 30 THEN 'overweight'
    ELSE 'obese'
  END
WHERE height IS NOT NULL AND weight IS NOT NULL;
```

### Шаг 3: Пересчитать КБЖУ для существующих пользователей (опционально)

После обновления базы данных, пользователи могут перезайти в раздел "Профиль" и нажать "Изменить" → "Сохранить", чтобы пересчитать свои КБЖУ по новой формуле.

Либо можно написать скрипт для автоматического пересчета всех пользователей.

## Формула расчета БЖУ (кратко)

### Белок
- Похудение: 1.8 г/кг
- Набор массы: 2.0 г/кг
- Поддержание: 1.6 г/кг
- Здоровье ЖКТ: 1.4 г/кг

**Коррекция:**
- При ожирении: максимум 1.6 г/кг
- При недоборе веса: минимум 1.8 г/кг

### Жиры
- Похудение: 0.8 г/кг
- Набор массы: 0.9 г/кг
- Поддержание: 0.9 г/кг
- Здоровье ЖКТ: 1.0 г/кг

**Коррекция:**
- При ожирении: минимум 0.7 г/кг

### Углеводы
- Рассчитываются остатком: `(калории - белки_ккал - жиры_ккал) / 4`
- Safety-блок предотвращает отрицательные значения

## Преимущества новой системы

1. ✅ Физиологически корректный расчет на основе веса тела
2. ✅ Учет особенностей организма через BMI
3. ✅ Защита гормональной системы (минимум жиров)
4. ✅ Индивидуальный подход к каждой весовой категории
5. ✅ Более точные рекомендации по питанию
6. ✅ Автоматическая коррекция при экстремальных значениях

## Тестирование

Рекомендуется протестировать расчет для разных сценариев:

1. Пользователь с недобором веса (BMI < 18.5)
2. Пользователь с нормальным весом (BMI 18.5-25)
3. Пользователь с избыточным весом (BMI 25-30)
4. Пользователь с ожирением (BMI ≥ 30)

Проверьте, что БЖУ рассчитываются корректно и значения имеют смысл.
